package com.revpasswordmanager.ui;

import com.revpasswordmanager.service.*;

import java.util.Scanner;

public class MainMenu {

    public static void main(String[] args) throws Exception {

        Scanner sc = new Scanner(System.in);
        UserService userService = new UserService();
        PasswordService passwordService = new PasswordService();
        SecurityService securityService = new SecurityService();

        int userId = -1;

        while (true) {
            try {

                // =========================
                // BEFORE LOGIN MENU
                // =========================
                if (userId < 0) {

                    System.out.println("\n==============================");
                    System.out.println("1. Register");
                    System.out.println("2. Login");
                    System.out.println("3. Forgot Password");
                    System.out.println("4. Exit");
                    System.out.print("Enter your choice: ");

                    int choice = Integer.parseInt(sc.nextLine());

                    switch (choice) {

                        case 1: {   // Register
                            System.out.print("Name: ");
                            String name = sc.nextLine();

                            System.out.print("Email: ");
                            String email = sc.nextLine();

                            System.out.print("Password: ");
                            String password = sc.nextLine();

                            System.out.print("Security question: ");
                            String question = sc.nextLine();

                            System.out.print("Security answer: ");
                            String answer = sc.nextLine();

                            try {
                                userService.registerWithSecurityQuestion(
                                        name, email, password, question, answer);
                                System.out.println("Registered successfully");
                            } catch (IllegalArgumentException e) {
                                System.out.println("Registration failed: " + e.getMessage());
                            }
                            break;
                        }

                        case 2: {   // Login
                            System.out.print("Email: ");
                            String email = sc.nextLine();

                            System.out.print("Password: ");
                            String password = sc.nextLine();

                            userId = userService.login(email, password);

                            if (userId > 0) {
                                System.out.println("Login successful");
                            } else {
                                System.out.println("Invalid credentials");
                            }
                            break;
                        }

                        case 3: {   // Forgot Password
                            System.out.print("Enter registered email: ");
                            String email = sc.nextLine();

                            int uid = userService.findUserByEmail(email);
                            if (uid < 0) {
                                System.out.println("Email not found");
                                break;
                            }

                            String question = securityService.getQuestion(uid);
                            System.out.println("Security Question: " + question);

                            System.out.print("Enter your answer: ");
                            String answer = sc.nextLine();

                            if (!securityService.validate(uid, answer)) {
                                System.out.println("Incorrect security answer");
                                break;
                            }

                            String code = securityService.getCode(uid);
                            System.out.println("Verification Code (demo): " + code);

                            System.out.print("Enter verification code: ");
                            String enteredCode = sc.nextLine();

                            if (!securityService.verifyCode(uid, enteredCode)) {
                                System.out.println("Invalid or expired code");
                                break;
                            }

                            System.out.print("Enter new master password: ");
                            String newPassword = sc.nextLine();

                            userService.resetPassword(uid, newPassword);
                            System.out.println("Password reset successful");
                            break;
                        }

                        case 4:
                            System.out.println("Exiting application");
                            sc.close();
                            System.exit(0);

                        default:
                            System.out.println("Invalid choice");
                    }
                }

                // =========================
                // AFTER LOGIN MENU
                // =========================
                else {

                    System.out.println("\n==============================");
                    System.out.println("1. Update Master Profile");
                    System.out.println("2. Add Password");
                    System.out.println("3. List of All Passwords");
                    System.out.println("4. View Single Account Password");
                    System.out.println("5. Update Account Password");
                    System.out.println("6. Delete Account Name ");
                    System.out.println("7. Logout");
                    System.out.println("8. Exit");
                    System.out.print("Enter your choice: ");

                    int choice = Integer.parseInt(sc.nextLine());

                    switch (choice) {

                        case 1: {   // Update Profile
                            System.out.print("New name: ");
                            String name = sc.nextLine();

                            System.out.print("New email: ");
                            String email = sc.nextLine();

                            System.out.print("New master password: ");
                            String pwd = sc.nextLine();

                            boolean updated = userService.updateProfile(userId, name, email, pwd);
                            System.out.println(updated ? "Profile updated" : "Update failed");
                            break;
                        }

                        case 2: {   // Add Password
                            System.out.print("Account name: ");
                            String account = sc.nextLine();

                            System.out.print("Username: ");
                            String username = sc.nextLine();

                            System.out.print("Password: ");
                            String pwd = sc.nextLine();

                            passwordService.add(userId, account, username, pwd);
                            System.out.println("Password saved");
                            break;
                        }

                        case 3: {   // List Passwords
                            System.out.print("Re-enter master password: ");
                            String mp = sc.nextLine();

                            if (!userService.verifyMasterPassword(userId, mp)) {
                                System.out.println("Incorrect master password");
                                break;
                            }

                            passwordService.list(userId);
                            break;
                        }

                        case 4: {   // View Account Password
                            System.out.print("Account name: ");
                            String account = sc.nextLine();

                            System.out.print("Re-enter master password: ");
                            String mp = sc.nextLine();

                            if (!userService.verifyMasterPassword(userId, mp)) {
                                System.out.println("Incorrect master password");
                                break;
                            }

                            String pwd = passwordService.viewPassword(userId, account);
                            System.out.println(pwd == null ? "Account not found"
                                    : "Password: " + pwd);
                            break;
                        }

                        case 5: {   // Update Password
                            System.out.print("Account name: ");
                            String acc = sc.nextLine();

                            System.out.print("New password: ");
                            String pwd = sc.nextLine();

                            System.out.println(
                                    passwordService.update(userId, acc, pwd)
                                            ? "Password updated"
                                            : "Account not found");
                            break;
                        }

                        case 6: {   // Delete Password
                            System.out.print("Account name: ");
                            String acc = sc.nextLine();

                            System.out.println(
                                    passwordService.delete(userId, acc)
                                            ? "Password deleted"
                                            : "Account not found");
                            break;
                        }

                        case 7: {   // Logout
                            userId = -1;
                            System.out.println("Logged out successfully");
                            break;
                        }

                        case 8:
                            System.out.println("Exiting application");
                            sc.close();
                            System.exit(0);

                        default:
                            System.out.println("Invalid choice");
                    }
                }

            } catch (Exception e) {
                System.out.println("Error: " + e.getMessage());
            }
        }
}
}