package com.revpasswordmanager.ui;

import com.revpasswordmanager.service.*;

import java.util.Scanner;

public class MainMenu {

    public static void main(String[] args) throws Exception {

        Scanner sc = new Scanner(System.in);
        UserService userService = new UserService();
        PasswordService passwordService = new PasswordService();
        SecurityService securityService = new SecurityService();

        int userId = -1;

        while (true) {
        	try {
        		System.out.println("\n==============================");
            	System.out.println("1. Register");
            	System.out.println("2. Login");
            	System.out.println("3. Update Profile");
            	System.out.println("4. Add Password");
            	System.out.println("5. List Passwords");
            	System.out.println("6. View Account Password");
            	System.out.println("7. Add Security Question");
            	System.out.println("8. Forgot Password");
            	System.out.println("9. Update Password");
            	System.out.println("10. Delete Password");
            	System.out.println("11. Logout");
            	System.out.println("12. Exit");
            	System.out.print("Enter your choice: ");
        		String input = sc.nextLine();
        		int choice = Integer.parseInt(input);

        		switch (choice) {

        		case 1: {
        		    System.out.print("Name: ");
        		    String name = sc.nextLine();

        		    System.out.print("Email: ");
        		    String email = sc.nextLine();

        		    System.out.print("Password: ");
        		    String password = sc.nextLine();

        		    System.out.print("Security question: ");
        		    String question = sc.nextLine();

        		    System.out.print("Security answer: ");
        		    String answer = sc.nextLine();

        		    try {
        		        userService.registerWithSecurityQuestion(
        		            name, email, password, question, answer
        		        );
        		        System.out.println("Registered successfully with security question");
        		    } catch (IllegalArgumentException e) {
        		        System.out.println("Registration failed: " + e.getMessage());
        		    }
        		    break;
        		}

        		    	
        		case 2: {
        		    if (userId > 0) {
        		        System.out.println("You are already logged in. Please logout first.");
        		        break;
        		    }

        		    System.out.print("Email: ");
        		    String email = sc.nextLine();     //  declared here

        		    System.out.print("Password: ");
        		    String password = sc.nextLine();  //  declared here

        		    userId = userService.login(email, password);

        		    if (userId > 0) {
        		        System.out.println("Login successful");
        		    } else {
        		        System.out.println("Invalid credentials");
        		    }
        		    break;
        		}
        		case 3: {
        		    if (userId < 0) {
        		        System.out.println("Please login first");
        		        break;
        		    }

        		    System.out.print("Enter new name: ");
        		    String newName = sc.nextLine();

        		    System.out.print("Enter new email: ");
        		    String newEmail = sc.nextLine();

        		    System.out.print("Enter new master password: ");
        		    String newPassword = sc.nextLine();

        		    try {
        		        boolean updated = userService.updateProfile(
        		            userId, newName, newEmail, newPassword
        		        );

        		        if (updated) {
        		            System.out.println("Profile updated successfully");
        		        } else {
        		            System.out.println("Profile update failed");
        		        }

        		    } catch (IllegalArgumentException e) {
        		        System.out.println("Update failed: " + e.getMessage());
        		    }

        		    break;
        		}



        		       case 4: {
        		    	    if (userId < 0) {
        		    	        System.out.println("Please login first");
        		    	        break;
        		    	    }

        		    	    System.out.print("Account name: ");
        		    	    String account = sc.nextLine();

        		    	    System.out.print("Username: ");
        		    	    String username = sc.nextLine();

        		    	    System.out.print("Password: ");
        		    	    String password = sc.nextLine();   //DECLARED HERE

        		    	    try {
        		    	        passwordService.add(userId, account, username, password);
        		    	        System.out.println("Password saved");
        		    	    } catch (IllegalArgumentException e) {
        		    	        System.out.println("Password not saved: " + e.getMessage());
        		    	    }

        		    	    break;
        		    	}

        		    case 5:
        		        if (userId < 0) {
        		            System.out.println(" Please login first");
        		            break;
        		        }

        		        passwordService.list(userId);
        		        break;
        		        
        		    case 6: {
        		        if (userId < 0) {
        		            System.out.println("Please login first");
        		            break;
        		        }

        		        System.out.print("Enter account name to view password: ");
        		        String accountName = sc.nextLine();

        		        System.out.print("Re-enter master password: ");
        		        String masterPwd = sc.nextLine();

        		        boolean verified = userService.verifyMasterPassword(userId, masterPwd);

        		        if (!verified) {
        		            System.out.println("Incorrect master password");
        		            break;
        		        }

        		        String actualPassword = passwordService.viewPassword(userId, accountName);

        		        if (actualPassword == null) {
        		            System.out.println("Account not found");
        		        } else {
        		            System.out.println("Password for " + accountName + " : " + actualPassword);
        		        }

        		        break;
        		    }


        		    case 7: {
        		        if (userId < 0) {
        		            System.out.println("Please login first");
        		            break;
        		        }

        		        System.out.print("Enter security question: ");
        		        String question = sc.nextLine();

        		        System.out.print("Enter answer: ");
        		        String answer = sc.nextLine();

        		        securityService.addQuestion(userId, question, answer);
        		        System.out.println("Security question added");
        		        break;
        		    }

        		    case 8: {
        		        System.out.print("Enter registered email: ");
        		        String email = sc.nextLine();

        		        int uid = userService.findUserByEmail(email);
        		        if (uid < 0) {
        		            System.out.println("Email not found");
        		            break;
        		        }

        		        //  FETCH & SHOW QUESTION
        		        String question = securityService.getQuestion(uid);
        		        if (question == null) {
        		            System.out.println("No security question found for this account");
        		            break;
        		        }

        		        System.out.println("Security Question: " + question);
        		        System.out.print("Enter your answer: ");
        		        String answer = sc.nextLine();

        		        if (!securityService.validate(uid, answer)) {
        		            System.out.println("Incorrect security answer");
        		            break;
        		        }

        		        String code = securityService.getCode(uid);
        		        System.out.println("Verification Code (demo): " + code);

        		        System.out.print("Enter verification code: ");
        		        String enteredCode = sc.nextLine();

        		        if (!securityService.verifyCode(uid, enteredCode)) {
        		            System.out.println("Invalid or expired verification code");
        		            break;
        		        }

        		        System.out.print("Enter new master password: ");
        		        String newPassword = sc.nextLine();

        		        userService.resetPassword(uid, newPassword);
        		        System.out.println("Password reset successful");
        		        break;
        		    }

        		    case 9:
        		        if (userId < 0) {
        		            System.out.println("Please login first");
        		            break;
        		        }

        		        System.out.print("Enter account name to update: ");
        		        String updateAccount = sc.nextLine();

        		        System.out.print("Enter new password: ");
        		        String newPwd = sc.nextLine();

        		        boolean updated = passwordService.update(userId, updateAccount, newPwd);

        		        if (updated) {
        		            System.out.println("Password updated successfully");
        		        } else {
        		            System.out.println("Account not found");
        		        }
        		        break;
        		    case 10:
        		        if (userId < 0) {
        		            System.out.println("Please login first");
        		            break;
        		        }

        		        System.out.print("Enter account name to delete: ");
        		        String deleteAccount = sc.nextLine();

        		        boolean deleted = passwordService.delete(userId, deleteAccount);

        		        if (deleted) {
        		            System.out.println("Password deleted successfully");
        		        } else {
        		            System.out.println("Account not found");
        		        }
        		        break;

        		    case 11:
        		        if (userId < 0) {
        		            System.out.println("You are not logged in.");
        		        } else {
        		            userId = -1;
        		            System.out.println("Logged out successfully.");
        		        }
        		        break;


        		    case 12:
        		        System.out.println(" Exiting application");
        		        sc.close();
        		        System.exit(0);

        		    default:
        		        System.out.println(" Invalid choice");
        		}

        	}
        	catch (Exception e) {
                System.out.println(" Error: " + e.getMessage());
        	}
}}}